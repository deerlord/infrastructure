#!/bin/bash

source ./config

export VOLUMES=/var/lib/docker/volumes

setup_prep() {
  /usr/sbin/useradd -r -s /sbin/nologin $1
}

container_prep() {
  container="$1"
  mkdir -p ./.build/$container
  cd ./.build/$container
}

container_build() {
  container="$1"
  if [[ -e Dockerfile ]]
  then
    docker build --pull --no-cache -t $container .
  fi
  cd ../../
  rm -rf ./.build/$container
}

basic_container() {
  container=$1
  echo docker create \
    $(run_as $container) \
    --restart=unless-stopped \
    --name=$container
}

container_use_system_time() {
  echo \
    -v '/etc/localtime:/etc/localtime:ro' \
    -v '/etc/timezone:/etc/timezone:ro' 
}

container_exists() {
  if [[ $(docker ps -a | grep -c $1) -eq 1 ]]
  then
    echo 1
  else
    echo 0
  fi
}

container_running() {
  if [[ $(docker ps | grep -c $1) -eq 1 ]]
  then
    echo 1
  else
    echo 0
  fi
}

public_service() {
  NAME=$1
  echo "${HOST_IP} ${NAME}.${HOST_DOMAIN}" >> ${VOLUMES}/dnsmasq/_data/local_hosts
  docker restart nameresolution
}

run_as() {
  echo "--env USER_ID=$(id -u $1) --env GROUP_ID=$(id -g $1)"
}

update_ad_domains() {
  list='https://raw.githubusercontent.com/hectorm/hmirror/master/data/adaway.org/list.txt'
  echo "0.0.0.0 $(curl ${list} 2>/dev/null | tr '\n' ' ')" \
    > ${VOLUMES}/dnsmasq/_data/ad_domains
}

add_static_lease() {
  mac_address="$1"
  ip="$2"
  has_lease=$(grep -c ${ip} ${VOLUMES}/dnsmasq/_data/static)
  if [[ $has_lease -eq 0 ]]
  then
    echo "dhcp-host=${mac_address},${ip}" >> ${VOLUMES}/dnsmasq/_data/static
    if [[ $(container_running dnsmasq) -eq 1 ]]
    then
      docker restart dnsmasq
    fi
  fi
}

set_volume_ownership() {
  user="$1"
  if [[ -z $2 ]]
  then
    vol=$user
  else
    vol=$2
  fi
  if [[ -z $3 ]]
  then
    group=$user
  else
    group=$3
  fi
  chown -R ${user}:${group} ${VOLUMES}/${vol}/_data/
  chmod -R o-rwx ${VOLUMES}/${vol}/_data/
}

export -f container_prep
export -f container_build
export -f basic_container
export -f container_use_system_time
export -f container_exists
export -f container_running
export -f public_service
export -f run_as
export -f update_ad_domains
export -f add_static_lease
export -f set_volume_ownership
export -f setup_prep
