#!/bin/bash

source ./conf.d/CONFIG

export VOLUMES=${VOLUMES}
export APT_UPDATE='RUN apt update -y; apt upgrade -y'
export DOCKER_DEBIAN='FROM debian$(echo -e \n)RUN apt update -y; apt upgrade -y'

container_prep() {
  container="$1"
  mkdir -p ./.build/$container
  cd ./.build/$container
  /usr/sbin/useradd -r -s /sbin/nologin $container
}

container_build() {
  container="$1"
  docker build -t $container .
  cd ../../
  rm -rf ./.build/$container
}


dev_remove_containers() {
  docker ps -a | awk '{print $1}' | grep -v 'CONTAINER' | while read id
  do
    docker stop $id
    docker rm $id
  done
}

dev_remove_images() {
  docker images -a | awk '{print $3}' | grep -v 'IMAGE' | while read id
  do
    docker rmi -f $id
  done
  docker volume rm nginx
  docker volume rm ssl
  docker volume rm dnsmasq
  docker volume rm openhab_addons
  docker volume rm openhab_conf
  docker volume rm openhab_userdata
  docker volume rm squid_conf
  docker volume rm squid_spool
  docker network rm egress
  docker network rm openhab
  docker network rm openhab_http_egress
  docker network rm openhab_http_ingress
}

basic_container() {
  container=$1
  echo docker create \
    $(run_as $container) \
    --restart=unless-stopped \
    --name=$container
}

container_exists() {
  if [[ $(docker ps -a | grep -c $1) -eq 1 ]]
  then
    echo 1
  else
    echo 0
  fi
}

container_running() {
  if [[ $(docker ps | grep -c $1) -eq 1 ]]
  then
    echo 1
  else
    echo 0
  fi
}

public_service() {
  NAME=$1
  echo "${HOST_IP} ${NAME}.${HOST_DOMAIN}" >> ${VOLUMES}/dnsmasq/_data/local_hosts
  docker restart dnsmasq
}

http_egress() {
  container=$1
  network="${container}_http_egress"
  if [[ $(docker network ls | awk '{print $2}' | grep -c $network) -eq 0 ]]
  then
    docker network create $network --internal
  fi
  if [[ $(container_exists squid) -eq 1 && $(container_exists $container) -eq 1 ]]
  then
    docker network connect $network $container
    docker network connect $network squid
  fi
}

http_ingress() {
  container=$1
  network="${container}_http_ingress"
  if [[ $(docker network ls | awk '{print $2}' | grep -c $network) -eq 0 ]]
  then
    docker network create $network --internal
  fi
  if [[ $(container_exists nginx) -eq 1 && $(container_exists $container) -eq 1 ]]
  then
    conf="${VOLUMES}/nginx/_data/conf.d/${container}.conf"
cat > $conf <<'EOF'
server {
  listen 443 ssl;
  server_name container.HOST_DOMAIN;
  location / {
    proxy_pass http://container:8080/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Request-URI $request_uri;
  }
}
EOF
    sed -i \
      -e "s container ${container} g" \
      -e "s HOST_DOMAIN ${HOST_DOMAIN} g" \
      $conf
    chown nginx $conf
    docker network connect $network $container
    docker network connect $network nginx
    public_service $container
  fi
}

remove_http_ingress() {
  container=$1
  network="${container}_http_ingress"
  mv -v ${VOLUMES}/nginx/_data/conf.d/${container}.conf{,-disabled}
  docker network disconnect $network $container > /dev/null 2>&1
  docker network disconnect $network nginx > /dev/null 2>&1
  docker network remove $network > /dev/null 2>&1
  mv -v ${VOLUMES}/nginx/_data/conf.d/${container}.conf{,-disabled}
}

remove_http_egress() {
  container=$1
  network="${container}_http_egress"
  docker network disconnect $network $container > /dev/null 2>&1
  docker network disconnect $network squid > /dev/null 2>&1
  docker network remove $network > /dev/null 2>&1
}

run_as() {
  echo "--env USER_ID=$(id -u $1) --env GROUP_ID=$(id -g $1)"
}

add_openhab_http_item() {
  name="$1"
  cert="$2"
  # verify and possibly convert cert
  existing_cert=$(grep -l "${2}" ${VOLUMES}/ss/_data/clients/* | grep -c "${name}")
  if [[ ${existing_cert} -eq 0 ]]
  then
    echo "${cert}" > ${VOLUMES}/ssl/_data/clients/${name}.crt
    chown nginx. ${VOLUMES}/ssl/_data/clients/${name}.crt
    cat ${VOLUMES}/ssl/_data/clients/${name}.crt >> \
      ${VOLUMES}/ssl/_data/clients.crt
  fi

}

update_ad_domains() {
  list='https://raw.githubusercontent.com/hectorm/hmirror/master/data/adaway.org/list.txt'
  echo "${HOST_IP} $(curl ${list} 2>/dev/null | tr '\n' ' ')" \
    > ${VOLUMES}/dnsmasq/_data/ad_domains
}

add_static_lease() {
  mac_address="$1"
  ip="$2"
  has_lease=$(grep -c ${ip} ${VOLUMES}/dnsmasq/_data/static) 
  if [[ $has_lease -eq 0 ]]
  then
    echo "dhcp-host=${mac_address},${ip}" >> ${VOLUMES}/dnsmasq/_data/static
    if [[ $(container_running dnsmasq) -eq 1 ]]
    then
      docker restart dnsmasq
    fi
  fi
}

set_volume_ownership() {
  user="$1"
  if [[ -z $2 ]]
  then
    vol=$user
  else
    vol=$2
  fi
  chown -R ${user} ${VOLUMES}/${vol}/_data/
  chmod -R o-rwx ${VOLUMES}/${vol}/_data/
}

export -f basic_container
export -f container_exists
export -f container_running
export -f public_service
export -f http_egress
export -f http_ingress
export -f remove_http_ingress
export -f remove_http_egress
export -f run_as
export -f update_ad_domains
export -f add_static_lease
export -f set_volume_ownership
