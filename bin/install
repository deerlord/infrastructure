#!/bin/bash
#
# This script has only been tested on
# $ uname -v
#     1 SMP Debian 4.19.67-2+deb10u2 (2019-11-11)

set -euo pipefail

if [[ ! -f ./conf.d/CONFIG ]]
then
  echo 'No CONFIG file found,'
  echo '$ cp ./conf.d/CONFIG{.sample,}'
  echo 'then edit it accordingly.'
  exit 1
fi

source ./bin/activate

apt update -y
apt upgrade -y
apt install -y docker.io
systemctl start docker
systemctl enable docker

interface='enp0s25'
sed -e "/^iface ${interface}/ d" -i /etc/network/interfaces
cat >> /etc/network/interfaces <<EOF
auto ${interface}
iface ${interface} inet static
  address ${HOST_IP}
  netmask ${HOST_SUBNET}
  gateway ${HOST_GATEWAY}
  dns-nameservers localhost
EOF

# firewall rules
#/usr/sbin/iptables -A INPUT -p icmp --icmp-type echo-request -j REJECT

if [[ -e /opt/infra ]]
then
  echo 'Install directory /opt/infra/ already exists, aborting.'
  exit 1
fi

mkdir /opt/infra/
cp -r ./ /opt/infra/

all() {
  for image in $(ls ./containers/ | grep -v command)
  do
    containers/$image/build
    containers/$image/create
  done
}

debug() {
  bash -x ./containers/00-dnsmasq/build
  bash -x ./containers/00-dnsmasq/create
  bash -x ./containers/01-ntpd/build
  bash -x ./containers/01-ntpd/create
}

all
