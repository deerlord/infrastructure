#!/bin/bash
#
# This script has only been tested on
# $ uname -v
#     1 SMP Debian 4.19.67-2+deb10u2 (2019-11-11)
#
# error codes
# 1: config file not specified
# 2: config file not found
# 3: install directory already exists

set -euo pipefail

INSTALL_DIR=/opt/infra

if [[ ${1} == -c ]]
then
  config="${2}"
  if [[ -e ${config} ]]
  then
    echo "Using ${config} as configuration file."
  else
   echo "Cannot find specified config file (${config}), aborting." >2
   exit 2
  fi
else
  echo "No config file specified, aborting." >2
  echo "ex:" >2
  echo "  $ ./bin/install -c /home/user/infra.conf" >2
  exit 1
fi

if [[ -e ${INSTALL_DIR} ]]
then
  echo "Install directory ${INSTALL_DIR} already exists, aborting."
  exit 3
fi

mkdir -p ${INSTALL_DIR}
cp -r ./ ${INSTALL_DIR}
cp ${config} ${INSTALL_DIR}/conf.d/CONFIG
cd ${INSTALL_DIR}

source ./bin/activate

apt update -y
apt upgrade -y
apt install -y docker.io
systemctl start docker
systemctl enable docker

interface='enp0s25'
sed -e "/^iface ${interface}/ d" -i /etc/network/interfaces
cat >> /etc/network/interfaces <<EOF
auto ${interface}
iface ${interface} inet static
  address ${HOST_IP}
  netmask ${HOST_SUBNET}
  gateway ${HOST_GATEWAY}
  dns-nameservers localhost
EOF

# firewall rules
#/usr/sbin/iptables -A INPUT -p icmp --icmp-type echo-request -j REJECT

all_containers() {
	for image in $(ls ./containers/)
  do
    containers/$image/build
    containers/$image/create
    if [[ -f containers/$image/cron ]]
    then
      container=$(echo $image | cut -d'-' -f2)
      cp containers/$image/cron /etc/cron.d/$container
    fi
  done
}
