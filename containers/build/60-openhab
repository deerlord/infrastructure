#!/bin/bash

docker pull openhab/openhab
/usr/sbin/useradd -r -s /sbin/nologin openhab
docker volume create openhab_conf
docker volume create openhab_userdata
docker volume create openhab_addons
docker volume create openhab_database
docker network create --internal --subnet=172.19.0.0/29 openhab_proxy
./containers/start *-openhab
sleep 10
docker stop openhab
docker rm openhab
cat >> /var/lib/docker/volumes/openhab_conf/_data/services/addons.cfg <<'EOF'
persistence = 'jdbc'
EOF
cat > /var/lib/docker/volumes/openhab_conf/_data/services/jdbc.cfg <<'EOF'
url=jdbc:sqlite:/openhab/database/sqlite.db
EOF
cat > /var/lib/docker/volumes/nginx/_data/conf.d/openhab.conf <<'EOF'
server {
  listen 443 ssl;
  server_name openhab.deerlord.lan;
  location / {
    proxy_pass http://openhab:8080/;
  }
}
EOF
chown -R openhab /var/lib/docker/volumes/openhab_*/_data/
chown nginx /var/lib/docker/volumes/nginx/_data/conf.d/openhab.conf
