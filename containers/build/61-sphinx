#!/bin/bash

/usr/sbin/useradd -r -s /sbin/nologin sphinx
docker network create --internal --subnet=172.19.0.8/29 sphinx_proxy
mkdir ./sphinx/
cd ./sphinx/
cat > speech.py <<'EOF'
from http.server import BaseHTTPRequestHandler, HTTPServer
from io import BytesIO
import speech_recognition as sr
class RequestHandler(BaseHTTPRequestHandler):
    def do_POST(self):
        content_length = int(self.headers['Content-Length'])
        audio = self.rfile.read(content_length)
        self.send_response(200)
        self.end_headers()
        response = BytesIO()
        try:
            r = sr.Recognizer()
            result = r.recognize_sphinx(audio)
        except sr.UnknownValueError:
            result = None
        except sr.RequestError:
            result = None
        response.write(result)
        self.wfile.write(response)
httpd = HTTPServer(('', 8080), RequestHandler)
httpd.serve_forever()
EOF
cat > Dockerfile <<'EOF'
FROM debian
RUN apt update -y
RUN apt install -y python3.7
RUN apt install -y python3-pip
RUN pip3 install SpeechRecognition
RUN mkdir /opt/speech/
COPY ./speech.py /opt/speech
CMD ["python3", "/opt/speech/speech.py"]
EOF
docker build -t sphinx .
cd ..
rm -rf ./sphinx/
cat > /var/lib/docker/volumes/nginx/_data/conf.d/sphinx.conf <<'EOF'
upstream sphinx_upstream {
  server sphinx:8080;
  server localhost;
}
server {
  listen 443 ssl;
  server_name sphinx.HOST_DOMAIN;
  location / {
    proxy_pass http://sphinx_upstream/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Request-URI $request_uri;
  }
}
EOF
sed -i \
  -e "s HOST_DOMAIN ${HOST_DOMAIN} g" \
  /var/lib/docker/volumes/nginx/_data/conf.d/sphinx.conf
chown nginx /var/lib/docker/volumes/nginx/_data/conf.d/sphinx.conf
